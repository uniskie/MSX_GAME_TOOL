# KONAMI向けツール  説明書

-----------------------------------------------------------------------------

ゲームにクイックセーブ＆ミニチート&サウンドプレイヤーを追加

- `GRADIUS2.BAS` ... グラディウス2  
- `F1SPIRIT.BAS` ... F-1 SPIRIT  
- `PARODIUS.BAS` ... パロディウス  
- `GALIOUS.BAS`  ... ガリウスの迷宮  

ゲームにクイックセーブのみ追加

- `KONAMI.BAS`   ... コナミMSX1ソフト(RAM8KB)汎用  

サウンドプレイヤー単体

- `GRA2-MUS.BAS` ... グラディウス2  
- `F1SP-MUS.BAS` ... F-1 SPIRIT  
- `PARO-MUS.BAS` ... パロディウス  
- `GAL-MUS.BAS`  ... ガリウスの迷宮  
- `SAVE-MUS.BAS` ... *.OBJファイルの作成

サウンドプレイヤー(JUKE-BOX)対応ROM

```
Bytes   SHA1                                     Name
------- ---------------------------------------- ------------
131,072 4D51D3C5036311392B173A576BC7D91DC9FED6CB GALIOUS.ROM
131,072 D63E20369F98487767810A0C57603BEF6A2A07E5 GRADIUS2.ROM
131,072 42FBB18722DF3E34E5B0F935A2DC0CE0D85099E9 F1SPIRIT.ROM
131,072 2220363AE56EF707AB2471FCDB36F4816AD1D32C PARODIUS.ROM
-------------------------------------------------------------
```

-----------------------------------------------------------------------------

## 概要

対応機種：  

- MSX2/MSX2+/MSXturboR  
- 要:RAM64KB（メモリマッパ不要）  
- 要:VRAM128KB
- MSX-DOS/MSX-DOS2  
- 漢字ROM(`GAL-MUS.BAS`)

  ※ VRAMに状態セーブするため、MSX2/VRAM128KB以上が必要です。  
  ※ MSX1には非対応です。  

  新10倍が無くてもステートセーブロードできるようにするツールです。

  ゲーム中にクイックロードセーブしたり、  
  BASICに一時的に戻ってステートディスクセーブロードができます。

  新10倍+似非SDではSDを破壊してしまうのですが、  
  こちらのツールを使ってそのままセーブロードをすれば  
  その危険はありません。  

### 諸注意

  - 後挿しが必要です。  
    1chipMSXであればSHIFT+F12でスロット1端子を無効化→有効化切替できるので安全です。

  - ROMのバージョンによっては対応していない場合があります

  - 状態ロード時は、データが正常かどうかチェックしていない為、  
    状態セーブしていない状態で状態ロードすると暴走します。  

  - 新10倍カートリッジとの併用は保証外です。

-----------------------------------------------------------------------------

## 操作方法

ゲームごとに、BASICから
```
RUN"GALIOUS.BAS"⏎  
RUN"GRADIUS2.BAS"⏎  
RUN"F1SPIRIT.BAS"⏎  
RUN"PARODIUS.BAS"⏎  
RUN"KONAMI.BAS"⏎  
```
どれかを実行してから、
ゲームカートリッジを後挿ししてください。

ゲームカートリッジはスロット1,2いずれでも自動検知します。

あとはメニューに従って操作してください。


### メニュー：

- [G] 新規ゲーム開始
- [C] ゲーム再開（ゲームから復帰したときのみ表示）
- [S] ステートファイルをディスクへセーブする
- [L] ステートファイルをディスクからロードする
- [P] MSX1風似非パレット

### ゲーム中：

- [STOP]    : 拡張ポーズ＆拡張ポーズ解除

###   拡張ポーズ中:

- [S]       : クイックセーブ(QS1)  
- [L]       : クイックロード(QS1)  

- [P]       : JUKE-BOX (サウンドプレイヤー)
              (コナミ汎用はナシ)

- [C]       : 回復/パワーアップ

  - ガリウスの迷宮：ライフ＆弾回復  
  - グラディウス2  ：パワーアップ（ダブル+レーザー+ガリウス+Qバート+無敵：壊れ気味）  
  - F-1スピリット ：1位&修復&高速ピット等  
  - パロディウス  ：パワーアップ （ダブル+レーザー+無敵）  
  - (コナミ汎用はナシ)

- [CTRL]+[@]  : BASICへ戻る  
                終了時自動保存(QS2)も行う  

- [CTRL]+[L]  : 前回の終了時自動保存(QS2)を読み込む  
- [CTRL]+[S]  : クイックセーブ(QS1)＆自動保存(QS2)＆BASIC復帰  

- [CTRL]+[STOP] :ゲームリセット

-----------------------------------------------------------------------------

### 状態セーブの種類

状態セーブには2種類あります。

1. 「クイックセーブ」...ゲーム拡張ポーズ中に[S]で保存したり[L]で読み込む  
2. 「システム状態セーブ」...ゲームからBASICに戻った時に保存される  

2の「システム状態セーブ」があると再開時にそこから自動再開します。

BASIC画面でセーブ/ロードするのは1のクイックセーブデータのみです。

-----------------------------------------------------------------------------

## MSX1非対応について

こちらはMSX1では動きません。

ファイルへのセーブロードを簡単に行うため  
VRAMにステートセーブする構造になっていて、  
VRAM128KBが必要です。

自動ステートセーブをカットして、任意ステートセーブのみにすれば、  
MSX1にも対応できますが、  
VRAMではなく裏RAMにステートデータが置かれるため  
セーブロードルーチンもマシン語で書かなくてはいけなくなります。  
手間がかかりそうなので、MSX1への対応は未定です。


-----------------------------------------------------------------------------

# おまけ：JUKE-BOX

- `GAL-MUS.BAS`  
  ...「ガリウスの迷宮」JUKE-BOX (サウンドテスト)  

- `F1SP-MUS.BAS`  
  ...「F1-SPIRIT」JUKE-BOX (サウンドテスト)  

- `GRA2-MUS.BAS`  
  ...「グラディウス2」JUKE-BOX (サウンドテスト)  

- `PARO-MUS.BAS`  
  ...「パロディウス」JUKE-BOX (サウンドテスト)  

- `SAVE-MUS.BAS`  
  ... ゲームカートリッジからデータを読みだして、JUKE-BOX用OBJファイルを作成するツール  


拡張ツール内蔵のJUKE-BOXをROM無しで単体実行出来るようにしたものです。  

実行にはゲームカートリッジから作成したJUKE-BOX用OBJファイルが必要です。  

## 準備 : OBJファイルの作成

1. `SAVE-MUS.BAS`を実行
2. ゲームカートリッジを後挿し
3. ゲームカートリッジを自動認識し、ディスクへ各OBJファイルが書き出されます。

### 出力されるOBJファイル

- ガリウスの迷宮  

  `GAL-MUS.OBJ` (同梱無し/`SAVE-MUS.BAS`で作成)
  ... ROMバンク$00,$0D,$0Eをつなげたファイル  

- グラディウス2  

  `GRA2-MUS.OBJ` (同梱無し/`SAVE-MUS.BAS`で作成)
  ... ROMバンク$04,$05,$06をつなげたファイル  

- F-1スピリット  

  `F1SP-MUS.OBJ` (同梱無し/`SAVE-MUS.BAS`で作成)
  ... ROMバンク$0D,$0E,$0Fをつなげたファイル  

- パロディウス  

  `PARO-MUS.OBJ`
  ... ROMバンク$00,$04,$05,$06,$0Aをつなげたファイル  

## SCC音源

`PARO-MUS.BAS` （パロディウス）、`F1SP-MUS.BAS`（F1-SPIRIT）の演奏には、
スナッチャー付属のコナミサウンドカートリッジかSCC音源内蔵ゲームカートリッジが必要です。  

ゲームカートリッジの場合はカートリッジ後挿しが必要になります。


-----------------------------------------------------------------------------

# コナミ汎用ツール `KONAMI.BAS` 解説

コナミMSX1用ゲーム系は基本的に  
・ゲームの開始処理アドレス  
・ゲームの割り込み処理アドレス  
が違うだけで、他は流用できる可能性があります。  

コナミMSX1ソフト限定でクイックセーブ・ロードツール
（パワーアップやトレーナー機能なしの簡易版 新10倍）
を実験的に作成してみました。

今の所、RAM16KBを要求する沙羅曼蛇以外のMSX1ソフトでは使えると思います。
シャロムもゲーム内のディスク操作をしなければ大丈夫なようです。


## `KONAMI.BAS` で 実装しているもの

- RC???の型番が埋め込まれていないソフトの認識  
  ... 新10倍の処理を取り込んでいます

- クイックセーブ＆ロード
- BASICとの行き来
- ディスクへのセーブロード（BASICプログラムから）


## 未実装のもの

- メガロムかどうかの判定
- BANK番号のワークの判定（現在、決め打ちで`F0F0H`）
- SCCの判定（リストを作成すれば良さそう？）
- MSX2用ソフトへの対応 （予定なし）
- RAM16KBを使用するソフトへの対応（未定）
- JUKE BOX（共通化出来ないので予定なし）  

## 空き領域

1. MSX1用のゲームをMSX2で実行する場合、VRAM 4000H以降は未使用です。  

2. コナミのゲームはRAM8KB対応のソフトが多く、  
   そういったソフトはC000H-DFFFHが未使用です。  

`KONAMI.BAS`ではその空き領域にツールを配置して楽をしています。

このような構造の為、  
MSX2用ソフトはもちろん非対応ですし、  
RAM16KBを必要とする一部のコナミMSX1用ソフトには非対応です。

> - 沙羅曼蛇はC000Hから使用するので、`KONAMI.BAS`では非対応としました。
> - シャロムはディスクにセーブロードするときにC000Hから使用します。  
>   ゲーム内ディスクセーブロードを実行すると`KONAMI.BAS`は暴走します。
>   
>   進行上、セーブ→MSXリセット→ロードが必要なポイントがあるため、  
>   `KONAMI.BAS`使用時はパスワードか新10倍SRAMへのセーブを利用してください。

## 処理概要

ツール側のH.KEYIフックを書き込んで、拡張ポーズ機能を追加します。

そのフックをゲームプログラム側から上書きされないように、  
ゲームプログラム側のフック書き換えの次の命令から  
ゲームプログラムを実行します。

## 処理手順

1. ゲーム検索（IDの取得と照合）
   - 後期ソフトはID埋め込みがあるので早い。
   - 初期ソフトはチェックサムとの照合なので少し重い。
     （チェックサムリストは新10倍を参照して作成したもの）

2. `LD  SP,XXXXH        ;31 XX XX  `  
   を検索してゲームのスタックポインタXXXXHを取得。

3. `LD  HL,XXXXH        ;21 XX XX  `  
   `LD  (H_KEYI+1),HL   ;22 9B FD  `  
   を検索してゲーム中の割り込み処理アドレスXXXXHを取得。  
   自前の割り込み処理の後に呼び出すようにする。  
   また、 割り込みフック書き込みの後のアドレスを、
   ゲーム実行時のジャンプ先として保存。

4. ゲーム実行時のジャンプ先以前に、
   E000H以降のワークエリアを初期化しているコードがあれば、  
   初期化サイズを調べて、自分で初期化するようにする。
   （ソフトウェアリセット時にも初期化する）

5. ゲーム実行時のジャンプ先以前に、EIがあるか調べる。

6. わんぱくアスレチックなど、VDPワークエリアに書き込まないソフト対策として、
   コナミ標準の設定をVDPとワークエリアに書き込む

7. ゲーム開始時は、  
   1. `DI`  
   2. `IM 1`  
   3. ぺージ1(4000H)とページ2(8000H)のスロットをゲームのスロットに切り替え  
   4. スタックポインタをゲームのスタックポインタアドレスに設定  
   5. ワークエリアの初期化が必要なら初期化
   6. HLに自分の割り込み処理アドレスを入れて`LD  (H_KEYI+1),HL`へジャンプ  
      もしくは、  
      自分でH_KEYIを設定して、`LD  (H_KEYI+1),HL`の次のアドレスへジャンプ。  
      （ジャンプ先寄りて前にEIがあればEIしてからジャンプ）

> 例）ガリウスの迷宮  
> ```  
> 4002:   95 40   DW   4095H  
>     :  
> 4095:   F3    DI  
> 4096:   ED 56   IM   1  
> 4098:   CD D3 40  CALL 40D3H   ;GET PAGE1 SLOT No.  
> 409B:   26 80   LD   H,80H  
> 409D:   CD 24 00  CALL 0024H  
> 40A0:   3E C3   LD   A,0C3H  
> 40A2:   32 9A FD  LD   (H_KEYI),A  
> 40A5:   21 EF 40  LD   HL,40EFH  ;→ これを書き換えたい  
> 40A8:   22 9B FD  LD   (H_KEYI+1),HL  
> 40AB:  
> ```  
> - 割り込み処理: 40EFH  
> - ゲーム開始  : 40ABH （DI、H.KEYI割り込みフック設定、ページ2のスロット切り替え）  

> 例）グラディウス2  
> ```  
> 4002:   90 40   DW   4090H  
>     :  
> 4090:   F3    DI  
> 4091:   ED 56   IM   1  
> 4093:   3E C3   LD   A,0C3H  
> 4095:   32 9A FD  LD   (H_KEYI),A  
> 4098:   21 EF 40  LD   HL,4023H  ;→ これを書き換えたい  
> 409B:   22 9B FD  LD   (H_KEYI+1),HL  
> 409E:  
> ```  
> - 割り込み処理: `4023H  `  
> - ゲーム開始  : `409EH` （DI、H.KEYI割り込みフック設定）

## コナミ8Kバンク検査（未実装）

1. 型番リストを作って`4010h`～`4013h`の値を調べる  
   （牌の魔術師には使えない）  
2. バンク切り替え処理を検索して調べる。  

> 頻出例：  
> ```  
> LD (5000H),A  ;32 00 50 ;BANK0 切替  
> LD (7000H),A  ;32 00 70 ;BANK1 切替  
> LD (9000H),A  ;32 00 90 ;BANK2 切替  
> LD (A000H),A  ;32 00 A0 ;BANK3 切替  
> ```

> [!NOTE]  
>  
> ※ 実際にBANK0を切り替えているケースは見たことが無いので  
>   BANK0切り替えをしているソフトは存在しないかもしれません。

## ゲームIDの取得方法

詳細は `KONAMI8K.ASM` の GET_KONAMI_ID の処理を参考にしてください。

1. ロムヘッダ検査 (4000H が 'AB')
2. 4002Hに書かれたアドレスから+FFHの範囲に値としてH_TIMI(FD9Fh)かH_KEYI(FD9AH)があるか検査
3. 4010Hに'AB'か'CD'か'EF'があるか検査。あれば4012HHにゲームIDがある。（終了）
4. そうでなければ、5000H～50FFHの合計値を計算し、  
   ゲーム毎の合計値リストと照合してゲームIDを決定(終了)

## SCCかどうかの検査案

1. 型番に対するSCC対応表
   対応ゲームをリストで限定しているので、そこにSCC対応フラグを追加するのが早い

2. SCCバンク切り替えコードの存在を検索する  
   ```  
   LD   A,3Fh      ;3E 3F  
   LD   (9000h),A  ;32 00 90  
   ```

3. 検査コードを実行する

   (書き込み検査は、元の値を記憶→書き込み→書き込んだ値との一致検査→元の値に戻す)

   1. 8000Hに書き込めたらRAM
   2. SCC互換モード指定 (BFFEHに0を書き込み)
   3. コナミバンク2：バンク0を選択
      (9000Hに00Hを書き込み)
   4. 9800hに書き込めたらSCCなし
   5. コナミバンク2：SCCを選択
      (9000Hに3FHを書き込み)
   6. 9800hに書き込めたらSCCあり

   (調べ終わったら元の値に戻す)

   おまけ： SCCかSCC-1（スナッチャー/SDスナッチャー）か調べる

   1. SCC拡張モード指定 (BFFEHに20Hを書き込み)
   2. SCC拡張モードバンク選択 (B000Hに80Hを書き込み)
   3. B800Hに書き込めたらSCC-1

## 参考 コナミMSX用ゲームソフト


| 番号  | 機種 |動作|SCC| タイトル                       | 英語名                                  |  
|--------|-----|----|---|--------------------------------|-----------------------------------------|
| RC 700 | MSX | 〇 |   | わんぱくアスレチック           | Athletic Land                           |
| RC 701 | MSX | 〇 |   | けっきょく南極大冒険           | Antarctic Adventure                     |
| RC 702 | MSX | 〇 |   | モン太君のいち・に・さんすう   | Monkey Academy                          |
| RC 703 | MSX | 〇 |   | タイムパイロット               | Time Pilot                              |
| RC 704 | MSX | 〇 |   | フロッガー                     | Frogger                                 |
| RC 705 | MSX | 〇 |   | スーパーコブラ                 | Super Cobra                             |
| RC 706 | MSX | 〇 |   | コナミのビリヤード             | Konami’s Billiards (Video Hustler)     |
| RC 707 | MSX | 〇 |   | コナミの麻雀道場               | Konami’s Mahjong                       |
| RC 710 | MSX | 〇 |   | ハイパーオリンピック1          | Hyper Olympic 1 (Track & Field 1)       |
| RC 711 | MSX | 〇 |   | ハイパーオリンピック2          | Hyper Olympic 2 (Track & Field 2)       |
| RC 712 | MSX | 〇 |   | サーカスチャーリー             | Circus Charlie                          |
| RC 713 | MSX | 〇 |   | マジカルツリー                 | Magical Tree                            |
| RC 714 | MSX | 〇 |   | I love 社会 ぽんぽこパン       | Comic Bakery                            |
| RC 715 | MSX | 〇 |   | ハイパースポーツ1              | Hyper Sports 1                          |
| RC 716 | MSX | 〇 |   | キャベッジパッチキッズ         | Cabbage Patch Kids                      |
| RC 717 | MSX | 〇 |   | ハイパースポーツ2              | Hyper Sports 2                          |
| RC 718 | MSX | 〇 |   | ハイパーラリー                 | Hyper Rally                             |
| RC 720 | MSX | 〇 |   | コナミのテニス                 | Konami’s Tennis                        |
| RC 721 | MSX | 〇 |   | スカイジャガー                 | Sky Jaguar                              |
| RC 723 | MSX | 〇 |   | コナミのゴルフ                 | Konami’s Golf                          |
| RC 724 | MSX | 〇 |   | コナミのベースボール           | Konami’s Baseball                      |
| RC 725 | MSX | 〇 |   | イーアルカンフー               | Yie Ar Kung Fu                          |
| RC 727 | MSX | 〇 |   | 王家の谷                       | King’s Valley                          |
| RC 728 | MSX | 〇 |   | モピレンジャー                 | Mopi Ranger                             |
| RC 729 | MSX | 〇 |   | ピポルス                       | Pippols                                 |
| RC 730 | MSX | 〇 |   | ロードファイター               | Road Fighter                            |
| RC 731 | MSX | 〇 |   | コナミのピンポン               | Konami’s Ping Pong                     |
| RC 732 | MSX | 〇 |   | コナミのサッカー               | Konami’s Soccer (Konami’s Football)   |
| RC 733 | MSX | 〇 |   | ハイパースポーツ3              | Hyper Sports 3                          |
| RC 734 | MSX | 〇 |   | グーニーズ                     | The Goonies                             |
| RC 736 | MSX | 〇 |   | コナミのボクシング             | Konami’s Boxing                        |
| RC 737 | MSX | 〇 |   | イーガー皇帝の逆襲             | Yie Ar Kung Fu 2                        |
| RC 739 | MSX | 〇 |   | 魔城伝説                       | Knightmare                              |
| RC 740 | MSX | 〇 |   | ツインビー                     | Twin Bee                                |
| RC 742 | MSX | 〇 |   | グラディウス                   | Gradius (Nemesis)                       |
| RC 743 | MSX | 〇 |   | 夢大陸アドベンチャー           | Penguin Adventure                       |
| RC 744 | MSX2| -- |   | 悪魔城ドラキュラ               | Vampire Killer                          |
| RC 745 | MSX2| -- |   | キングコング2                  | King Kong 2                             |
| RC 746 | MSX | 〇 |   | Qバート                        | Q-Bert                                  |
| RC 747 | MSX2| -- |   | 火の鳥 鳳凰編                  | Hinotori (Firebird)                     |
| RC 748 | MSX2| -- |   | がんばれゴエモン!からくり道中  | Ganbare Goemon                          |
| RC 749 | MSX | 〇 |   | 魔城伝説Ⅱガリウスの迷宮       | The Maze of Galious                     |
| RC 750 | MSX2| -- |   | メタルギア                     | Metal Gear                              |
| RC 751 | MSX | 〇 |SCC| グラディウス2                  | Gradius 2 (Nemesis 2)                   |
| RC 752 | MSX | 〇 |SCC| F-1スピリット                  | F-1 Spirit                              |
| RC 753 | MSX2| -- |   | ウシャス                       | The Treasure of Usas                    |
| RC 754 | MSX | △ |   | シャロム 魔城伝説III 完結編    | Shalom                                  |
| RC 757 | MSX2| -- |SCC| THEプロ野球 激突ペナントレース | Clash Pennant Race 1                    |
| RC 758 | MSX | NG |SCC| 沙羅曼蛇                       | Salamander                              |
| RC 759 | MSX | 〇 |SCC| パロディウス                   | Parodius                                |
| RC 760 | MSX | ?? |SCC| エルギーザの封印 (MSX1)        | King’s Valley 2 (MSX1)                 |
| RC 761 | MSX2| -- |SCC| エルギーザの封印 (MSX2)        | King’s Valley 2 (MSX2)                 |
| RC 762 | MSX2| -- |SCC| 魂斗羅                         | Contra                                  |
| RC 764 | MSX | ?? |SCC| ゴーファーの野望EPISODEII      | Gofer’s Ambition Episode II (Nemesis 3)|
| RC 765 | MSX2| -- |DAC| 牌の魔術師                     | Hai no Majutsushi                       |
| RC 766 | MSX2| -- |SCC| 激突ペナントレース2            | Clash Pennant Race 2                    |
| RC 767 | MSX2| -- |SCC| ソリッドスネークメタルギア2    | Metal Gear 2                            |
| RC 768 | MSX2| -- |SCC| スペースマンボウ               | Space Manbow                            |

※ 〇が付いていても未検証のものもあります。
