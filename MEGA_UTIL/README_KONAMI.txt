# KONAMI向けツール  説明書

F1SPIRIT.BAS  
PARODIUS.BAS  
GALIOUS.BAS  

  MSX2/2+/turboR対応  
  要RAM64KB/VRAM128KB  
  MSX-DOS1/MSX-DOS2対応  

  ※ VRAMに状態セーブするため、MSX2/VRAM128KB以上が必要です。  
  ※ MSX1には非対応です。  

## 利用の目的

  新10倍が無くてもステートセーブロードできるようにするツールです。

  MegaRAM+SDやCarnivore2があれば、Sofarunを利用して、  
  1スロットでも新10倍＋ゲームの2本差しを再現実行できるので、  
  それらがある人には不要です。  

##【重要】新10倍と似非SD/SCSIを使う場合の注意

   【ディスク破壊の可能性】

  MSXDOS2カーネル改造版のSD/SCSIを利用する場合ですが、  
  MSXDOS2改造版ではなく【Nextor】を利用してください。  
  でないとディスクアクセス時に  
  （書き込みでなくても）ディスクを破壊する危険があります。  

  例えば1ChipMSXデフォルトではNextorではなくMSX-DOS2+似非SDで動作するのですが、  
  SDカードを読みに行くだけで、SDカードを壊してしまう確率が高いです。  
  自分は何度もSDカードの中身が壊れて涙目になりました。  

  OCM（1ChipMSX）に初期状態で組み込まれているSDカードドライバとの相性は特に悪い様子です。  
  OCMでもNextorを使うと平気なようです。  
  NextorのIDEドライバははMegaSDのものが使用できます。  
  （OCMのSDBIOS機能を利用するなどして変更可能です）  

  1ChipMSXではなく、MegaSDカートリッジの場合は  
  普通、Nextorがプリインストールされているので、  
  おそらくそのまま使って大丈夫だと思います。  

  ※ 他にも新10倍と相性の悪い組み合わせがあるかもしれません。

  心配な場合は、新10倍ではなこちらのPARODIUS.BASやGARIUS.BASを使っていただければ、  
  ディスク破壊の危険性が少なくなるかと思います。  

## MSX1非対応について

   こちらはMSX1では動きません。

   自動ステートセーブをカットして、任意ステートセーブのみにすれば、  
   MSX1にも対応できますが、  
   VRAMではなく裏RAMにステートデータが置かれるため  
   セーブロードルーチンもマシン語で書かなくてはいけなくなります。  
   そのため、MSX1対応には手を付けていません。  

   そのうち時間がとれれば、対応したいとは思いますが、  
   SofaRunの新10倍同時挿し再現機能を使えばいいので、  
   MSX1対応は要らないかな？とも思います。  

   （ファイルへのセーブロードを簡単に行うため  
   VRAMにステートセーブする構造になっています）  

## 操作方法

  - 拡張ポーズは[ESC]キーです。  
    （STOPキーでは新10倍とかぶるため）  

  - ゲーム中に拡張ポーズからクイックセーブロードが可能です。

  1chipMSX/MegaSD系では、新10倍の「丸ごと保存」がうまく動作しないケースが  
  ある為、こちらを利用すると良いかもしれません。  

  （新10倍でディスクアクセスするとSDカードの内容が破壊される事がある）

-  拡張ポーズ中に[P]でミュージックモードが実行できます。

-  BASICに戻ると戻る直前の状態を[S]ファイルにセーブ出来ます。

-  BASICから[L]で状態データをファイルから読み込んだ場合、  
   クイックセーブエリアに読み込むだけなので、  
   ゲーム開始後に拡張ポーズから[L]でクイックロードする必要があります。  
  （※起動時点では前回終了時の状態から再開か、新規ゲームになります）  

- （ガリウス）拡張ポーズ中に[C]で強制回復できます。

- （パロディウス）拡張ポーズ中に[C]でパワーアップできます。

## 諸注意

  - ROMのバージョンによっては対応していない場合があります

  - 状態ロード時は、データが正常かどうかチェックしていない為、  
    状態セーブしていない状態で状態ロードすると暴走します。  

  - 新10倍カートリッジとの併用は保証外です。

## 状態セーブの種類

  状態セーブには2種類あります。

  1. ゲーム中に[S]で保存したり[L]で読み込むユーザークイックセーブ  
  2. ゲームからBASICに戻った時に保存されるシステム自動状態セーブ  

  2があると再開時にそこから自動再開します。

  BASIC画面でセーブ/ロードするのは(1)のユーザークイックセーブデータです。

## 拡張ポーズ

### ゲーム中：

  [STOP]    : 拡張ポーズ＆拡張ポーズ解除

###   拡張ポーズ中:

  [S]       : クイックセーブ(QS1)  
  [L]       : クイックロード(QS1)  

  [P]       : ミュージックモード

  [C]       : ライフ＆弾回復（ガリウスの迷宮）  
          パワーアップ（パロディウス）  

  [CTRL]+[@]  : BASICへ戻る  
          終了時自動保存(QS2)も行う  
  [CTRL]+[L]  : 前回の終了時自動保存(QS2)を読み込む  
  [CTRL]+[S]  : クイックセーブ(QS1)＆自動保存(QS2)＆BASIC復帰  

  [CTRL]+[STOP] :ゲームリセット


# （検討事項）コナミ系を汎用化したい

  コナミMSX1用ゲーム系は基本的に、  
  ・ゲームの開始処理アドレス  
  ・ゲームの割り込み処理アドレス  
  が違うだけで、他は流用できる可能性があります。  
  （元々、新10倍カートリッジ用に色々と管理を工夫してあるため）  

## 仕様案

  - コナミのゲームはRAM8K対応が多い。その場合、  
    RAMはE000Hから使用（C000H-DFFFHは未使用）  
  - MSX1用のゲームをMSX2で実行する場合、VRAM 4000H以降は未使用  
  - BANK番号のワーク(`F0F1H`)が共通？（おそらく）  

  もう少し工夫すれば汎用にもできるかもしれません。  
  （インターネットを検索すれば既にありそうな気もします）  


  サウンド制御周りは、一部ワークエリアは配置が近いものの、  
  内部処理アドレスは異なるようです。  

## 処理案

  ツール側のH.KEYIフックを上書きされないために  
  ゲームプログラム側のフック書き換えの次の命令から  
  ゲームプログラムを実行します。

  検査のためのコード検索は、  
  ロムのINIT($4002,2bytes)に書かれたアドレスから検索すると効率が良いかもしれません。

### 手順

  1. `LD  SP,XXXXH        ;31 XX XX  `  
     を検索してゲームのスタックポインタXXXXHを取得。

  2. `LD  HL,XXXXH        ;21 XX XX  `  
     `LD  (H_KEYI+1),HL   ;22 9B FD  `  
     を検索してゲーム中の割り込み処理アドレスXXXXHを取得。  
     **自前の割り込み処理の後**に呼び出すようにする。  

  3. ゲーム実行時は、  
     1. `DI`  
     2. `IM 1`  
     3. ぺージ1(4000H)とページ2(8000H)のスロットをゲームのスロットに切り替え  
     4. スタックポインタをゲームのスタックポインタアドレスに設定  
     5. HLに自分の割り込み処理アドレスを入れて`LD  (H_KEYI+1),HL`へジャンプ  
        もしくは、  
        自分でH_KEYIを設定して、`LD  (H_KEYI+1),HL`の次のアドレスへジャンプ。  

  > 例）ガリウスの迷宮  
  > ```  
  > 4002:   95 40   DW   4095H  
  >     :  
  > 4095:   F3    DI  
  > 4096:   ED 56   IM   1  
  > 4098:   CD D3 40  CALL 40D3H   ;GET PAGE1 SLOT No.  
  > 409B:   26 80   LD   H,80H  
  > 409D:   CD 24 00  CALL 0024H  
  > 40A0:   3E C3   LD   A,0C3H  
  > 40A2:   32 9A FD  LD   (H_KEYI),A  
  > 40A5:   21 EF 40  LD   HL,40EFH  ;→ これを書き換えたい  
  > 40A8:   22 9B FD  LD   (H_KEYI+1),HL  
  > 40AB:  
  > ```  
  > - 割り込み処理: 40EFH  
  > - ゲーム開始  : 40ABH （DI、H.KEYI割り込みフック設定、ページ2のスロット切り替え）  

  > 例）グラディウス2  
  > ```  
  > 4002:   90 40   DW   4090H  
  >     :  
  > 4090:   F3    DI  
  > 4091:   ED 56   IM   1  
  > 4093:   3E C3   LD   A,0C3H  
  > 4095:   32 9A FD  LD   (H_KEYI),A  
  > 4098:   21 EF 40  LD   HL,4023H  ;→ これを書き換えたい  
  > 409B:   22 9B FD  LD   (H_KEYI+1),HL  
  > 409E:  
  > ```  
  > - 割り込み処理: `4023H  `  
  > - ゲーム開始  : `409EH` （DI、H.KEYI割り込みフック設定）


  ※ 新10倍の処理を解析して真似たらもっとスマートに出来る気もしますが、  
   古いソフトを検出する方法が複雑そうでした。  

## コナミ8Kバンク検査

   1) 型番リストを作って`4010h`～`4013h`の値を調べる  
   （牌の魔術師には使えない）  
   2) バンク切り替え処理を検索して調べる。  

  > 頻出例：  
  > ```  
  > LD (5000H),A  ;32 00 50 ;BANK0 切替  
  > LD (7000H),A  ;32 00 70 ;BANK1 切替  
  > LD (9000H),A  ;32 00 90 ;BANK2 切替  
  > LD (A000H),A  ;32 00 A0 ;BANK3 切替  
  > ```

  > [!NOTE]  
  >  
  > ※ 実際にBANK0を切り替えているケースは見たことが無いので  
  >   BANK0切り替えをしているソフトは存在しないかもしれません。

## コナミ8kバンク/SCCメガロムの識別案

  $4010からの型番埋め込みは後期から？

  - 非メガロムは基本的に型番埋め込みナシ  
  - メガロムでも牌の魔術師はナシ

  MEGAロム以外で型番が埋め込まれている物：  
  - グーニーズ         ('CD',07H,34H)  
  - 魔城伝説           ('CD',07H,39H)  
  - Qバート            ('CD',07H,46H)


  調べたのは手持ちのカートリッジだけなので、  
  他にも、メガロムでも型番が埋め込まれていない物や  
  非メガロムでも型番が埋め込まれている物はありそうです。  

  ```  
  $4000 (2): 'AB'  
  40002 (2): 起動時のジャンプアドレス  
  $4010 (2): 'AB' ... イーガー皇帝の逆襲  
             'EF' ... SHALOM、激ペナ  
             'CD' ... それ以外  
  $4012 (2): BCD形式での型番 (RC749 ガリウスの迷宮なら 07 49)  
  ```  


## SCCかどうかの検査案

  1) 型番リストを作って4010h-4013hの値を調べる  
  2) SCCバンク切り替えコードの存在を検索する  
     ```  
     LD   A,3Fh      ;3E 3F  
     LD   (9000h),A  ;32 00 90  
     ```

### 参考

新10倍カートリッジ対応表  
https://www.msx.org/wiki/Konami_Game_Master_2  

| Product | Title | Eng  
| --- | --- | ---  
| RC 700 | わんぱくアスレチック           | Athletic Land                           |
| RC 701 | けっきょく南極大冒険           | Antarctic Adventure                     |
| RC 702 | モン太君のいち・に・さんすう   | Monkey Academy                          |
| RC 703 | タイムパイロット               | Time Pilot                              |
| RC 704 | フロッガー                     | Frogger                                 |
| RC 705 | スーパーコブラ                 | Super Cobra                             |
| RC 706 | コナミのビリヤード             | Konami’s Billiards (Video Hustler)     |
| RC 707 | コナミの麻雀道場               | Konami’s Mahjong                       |
| RC 710 | ハイパーオリンピック1          | Hyper Olympic 1 (Track & Field 1)       |
| RC 711 | ハイパーオリンピック2          | Hyper Olympic 2 (Track & Field 2)       |
| RC 712 | サーカスチャーリー             | Circus Charlie                          |
| RC 713 | マジカルツリー                 | Magical Tree                            |
| RC 714 | I love 社会 ぽんぽこパン       | Comic Bakery                            |
| RC 715 | ハイパースポーツ1              | Hyper Sports 1                          |
| RC 716 | キャベッジパッチキッズ         | Cabbage Patch Kids                      |
| RC 717 | ハイパースポーツ2              | Hyper Sports 2                          |
| RC 718 | ハイパーラリー                 | Hyper Rally                             |
| RC 720 | コナミのテニス                 | Konami’s Tennis                        |
| RC 721 | スカイジャガー                 | Sky Jaguar                              |
| RC 724 | コナミのベースボール           | Konami’s Baseball                      |
| RC 725 | イーアルカンフー               | Yie Ar Kung Fu                          |
| RC 727 | 王家の谷                       | King’s Valley                          |
| RC 728 | モピレンジャー                 | Mopi Ranger                             |
| RC 729 | ピポルス                       | Pippols                                 |
| RC 730 | ロードファイター               | Road Fighter                            |
| RC 731 | コナミのピンポン               | Konami’s Ping Pong                     |
| RC 732 | コナミのサッカー               | Konami’s Soccer (Konami’s Football)   |
| RC 733 | ハイパースポーツ3              | Hyper Sports 3                          |
| RC 734 | グーニーズ                     | The Goonies                             |
| RC 736 | コナミのボクシング             | Konami’s Boxing                        |
| RC 737 | イーガー皇帝の逆襲             | Yie Ar Kung Fu 2                        |
| RC 739 | 魔城伝説                       | Knightmare                              |
| RC 740 | ツインビー                     | Twin Bee                                |
| RC 742 | グラディウス                   | Gradius (Nemesis)                       |
| RC 743 | 夢大陸アドベンチャー           | Penguin Adventure                       |
| RC 744 | 悪魔城ドラキュラ               | Vampire Killer                          |
| RC 745 | キングコング2                  | King Kong 2                             |
| RC 746 | Qバート                        | Q-Bert                                  |
| RC 747 | 火の鳥 鳳凰編                  | Hinotori (Firebird)                     |
| RC 748 | がんばれゴエモン!からくり道中  | Ganbare Goemon                          |
| RC 749 | 魔城伝説Ⅱガリウスの迷宮       | The Maze of Galious                     |
| RC 750 | メタルギア                     | Metal Gear                              |
| RC 751 | グラディウス2                  | Gradius 2 (Nemesis 2)                   |
| RC 752 | F-1スピリット                  | F-1 Spirit                              |
| RC 753 | ウシャス                       | The Treasure of Usas                    |
| RC 754 | シャロム 魔城伝説III 完結編    | Shalom                                  |
| RC 757 | THEプロ野球 激突ペナントレース | Clash Pennant Race 1                    |
| RC 758 | 沙羅曼蛇                       | Salamander                              |
| RC 759 | パロディウス                   | Parodius                                |
| RC 760 | エルギーザの封印 (MSX1)        | King’s Valley 2 (MSX1)                 |
| RC 761 | エルギーザの封印 (MSX2)        | King’s Valley 2 (MSX2)                 |
| RC 762 | 魂斗羅                         | Contra                                  |
| RC 764 | ゴーファーの野望EPISODEII      | Gofer's Ambition Episode II (Nemesis 3) |
| RC 765 | 牌の魔術師                     | Hai no Majutsushi                       |
| RC 766 | 激突ペナントレース2            | Clash Pennant Race 2                    |
| RC 767 | ソリッドスネークメタルギア2    | Metal Gear 2                            |
| RC 768 | スペースマンボウ               | Space Manbow                            |
