# KONAMI向けツール  説明書

-----------------------------------------------------------------------------
クイックセーブ＆ミニチート＆ミュージックボックス
- F1SPIRIT.BAS ... F-1 SPIRIT用
- PARODIUS.BAS ... パロディウス用  
- GALIOUS.BAS  ... ガリウスの迷宮用  

クイックセーブのみ
- KONAMI.BAS   ... コナミMSX1ソフト汎用  

-----------------------------------------------------------------------------
## 概要

  MSX2/2+/turboR対応  
  要RAM64KB/VRAM128KB  
  MSX-DOS1/MSX-DOS2対応  

  ※ VRAMに状態セーブするため、MSX2/VRAM128KB以上が必要です。  
  ※ MSX1には非対応です。  

  新10倍が無くてもステートセーブロードできるようにするツールです。

  ゲーム中にクイックロードセーブしたり、  
  BASICに一時的に戻ってステートディスクセーブロードができます。

  新10倍+似非SDではSDを破壊してしまうのですが、  
  こちらのツールを使ってそのままセーブロードをすれば  
  その危険はありません。  

### 諸注意

  - 後挿しが必要です。  
    1chipMSXであればSHIFT+F12でスロット1端子を無効化→有効化切替できるので安全です。

  - ROMのバージョンによっては対応していない場合があります

  - 状態ロード時は、データが正常かどうかチェックしていない為、  
    状態セーブしていない状態で状態ロードすると暴走します。  

  - 新10倍カートリッジとの併用は保証外です。

-----------------------------------------------------------------------------
## 操作方法

ゲームごとに、BASICから
```
RUN"F1SPIRIT.BAS"⏎  
RUN"PARODIUS.BAS"⏎  
RUN"GALIOUS.BAS"⏎  
RUN"KONAMI.BAS"⏎  
```
どれかを実行してから、
ゲームカートリッジを後挿ししてください。

ゲームカートリッジはスロット1,2いずれでも自動検知します。

あとはメニューに従って操作してください。


### メニュー：

  [G] 新規ゲーム開始
  [C] ゲーム再開（ゲームから復帰したときのみ表示）
  [S] ステートファイルをディスクへセーブする
  [L] ステートファイルをディスクからロードする
  [P] MSX1風似非パレット

### ゲーム中：

  [STOP]    : 拡張ポーズ＆拡張ポーズ解除

###   拡張ポーズ中:

  [S]       : クイックセーブ(QS1)  
  [L]       : クイックロード(QS1)  

  [P]       : ミュージックモード
              (コナミ汎用はナシ)

  [C]       : ガリウスの迷宮：ライフ＆弾回復  
              パロディウス  ：パワーアップ  
              F-1スピリット ：なし  
              (コナミ汎用はナシ)

  [CTRL]+[@]  : BASICへ戻る  
                終了時自動保存(QS2)も行う  

  [CTRL]+[L]  : 前回の終了時自動保存(QS2)を読み込む  
  [CTRL]+[S]  : クイックセーブ(QS1)＆自動保存(QS2)＆BASIC復帰  

  [CTRL]+[STOP] :ゲームリセット

-----------------------------------------------------------------------------
### 状態セーブの種類

  状態セーブには2種類あります。

  1. 「クイックセーブ」...ゲーム拡張ポーズ中に[S]で保存したり[L]で読み込む  
  2. 「システム状態セーブ」...ゲームからBASICに戻った時に保存される  

  2の「システム状態セーブ」があると再開時にそこから自動再開します。

  BASIC画面でセーブ/ロードするのは1のクイックセーブデータのみです。

-----------------------------------------------------------------------------

## MSX1非対応について

   こちらはMSX1では動きません。

   自動ステートセーブをカットして、任意ステートセーブのみにすれば、  
   MSX1にも対応できますが、  
   VRAMではなく裏RAMにステートデータが置かれるため  
   セーブロードルーチンもマシン語で書かなくてはいけなくなります。  
   そのため、MSX1対応には手を付けていません。  

   そのうち時間がとれれば、対応したいとは思いますが、  
   SofaRunの新10倍同時挿し再現機能を使えばいいので、  
   MSX1対応は要らないかな？とも思います。  

   （ファイルへのセーブロードを簡単に行うため  
   VRAMにステートセーブする構造になっています）  


-----------------------------------------------------------------------------

# コナミ汎用ツール KONAMI.BAS

  コナミMSX1用ゲーム系は基本的に  
  ・ゲームの開始処理アドレス  
  ・ゲームの割り込み処理アドレス  
  が違うだけで、他は流用できる可能性があります。  

  （元々、新10倍カートリッジ用に色々と管理を工夫してあるため）  

  コナミMSX1ソフト限定でクイックセーブ・ロードツール
  （パワーアップやトレーナー機能なしの簡易版 新10倍）
  を実験的に作成してみました。

## MSX2でコナミMSX1ソフトを動かす場合の空き領域

  - コナミのゲームはRAM8K対応が多い。
    その場合、RAMはE000Hから使用するので、C000H-DFFFHは未使用  

  - MSX1用のゲームをMSX2で実行する場合、VRAM 4000H以降は未使用  

  - MSX2用ソフトは空き領域が無いのでクイックセーブは無理
    また、フックを何度も書き換えるものもある

## 実装

  - RC???の型番が埋め込まれていないソフトの認識  
    ... 新10倍の処理を取り込んでいます

  - クイックセーブ＆ロード
  - BASICとの行き来
  - ディスクへのセーブロード（BASICプログラムから）


## 未実装

  - メガロムかどうかの判定
  - BANK番号のワーク(だいたいは`F0F1H`)の決定
  - SCCの判定
  - MSX2用ソフト対応 （予定なし）

  - JUKE BOX  
    サウンド制御周りは、一部ワークエリアは配置が近いものの、  
    内部処理やアドレスは異なるので汎用での対応は難しそう。  

## 処理概要

  

  ツール側のH.KEYIフックを書き込んで、拡張ポーズを追加します。

  そのフックをゲームから上書きされないように、  
  ゲームプログラム側のフック書き換えの次の命令から  
  ゲームプログラムを実行します。

### 手順

  1. ゲーム検索（IDの取得と照合）

  2. `LD  SP,XXXXH        ;31 XX XX  `  
     を検索してゲームのスタックポインタXXXXHを取得。

  2. `LD  HL,XXXXH        ;21 XX XX  `  
     `LD  (H_KEYI+1),HL   ;22 9B FD  `  
     を検索してゲーム中の割り込み処理アドレスXXXXHを取得。  
     **自前の割り込み処理の後**に呼び出すようにする。  

  3. ゲーム実行時は、  
     1. `DI`  
     2. `IM 1`  
     3. ぺージ1(4000H)とページ2(8000H)のスロットをゲームのスロットに切り替え  
     4. スタックポインタをゲームのスタックポインタアドレスに設定  
     5. HLに自分の割り込み処理アドレスを入れて`LD  (H_KEYI+1),HL`へジャンプ  
        もしくは、  
        自分でH_KEYIを設定して、`LD  (H_KEYI+1),HL`の次のアドレスへジャンプ。  

  > 例）ガリウスの迷宮  
  > ```  
  > 4002:   95 40   DW   4095H  
  >     :  
  > 4095:   F3    DI  
  > 4096:   ED 56   IM   1  
  > 4098:   CD D3 40  CALL 40D3H   ;GET PAGE1 SLOT No.  
  > 409B:   26 80   LD   H,80H  
  > 409D:   CD 24 00  CALL 0024H  
  > 40A0:   3E C3   LD   A,0C3H  
  > 40A2:   32 9A FD  LD   (H_KEYI),A  
  > 40A5:   21 EF 40  LD   HL,40EFH  ;→ これを書き換えたい  
  > 40A8:   22 9B FD  LD   (H_KEYI+1),HL  
  > 40AB:  
  > ```  
  > - 割り込み処理: 40EFH  
  > - ゲーム開始  : 40ABH （DI、H.KEYI割り込みフック設定、ページ2のスロット切り替え）  

  > 例）グラディウス2  
  > ```  
  > 4002:   90 40   DW   4090H  
  >     :  
  > 4090:   F3    DI  
  > 4091:   ED 56   IM   1  
  > 4093:   3E C3   LD   A,0C3H  
  > 4095:   32 9A FD  LD   (H_KEYI),A  
  > 4098:   21 EF 40  LD   HL,4023H  ;→ これを書き換えたい  
  > 409B:   22 9B FD  LD   (H_KEYI+1),HL  
  > 409E:  
  > ```  
  > - 割り込み処理: `4023H  `  
  > - ゲーム開始  : `409EH` （DI、H.KEYI割り込みフック設定）


## コナミ8Kバンク検査（未実装）

   1) 型番リストを作って`4010h`～`4013h`の値を調べる  
   （牌の魔術師には使えない）  
   2) バンク切り替え処理を検索して調べる。  

  > 頻出例：  
  > ```  
  > LD (5000H),A  ;32 00 50 ;BANK0 切替  
  > LD (7000H),A  ;32 00 70 ;BANK1 切替  
  > LD (9000H),A  ;32 00 90 ;BANK2 切替  
  > LD (A000H),A  ;32 00 A0 ;BANK3 切替  
  > ```

  > [!NOTE]  
  >  
  > ※ 実際にBANK0を切り替えているケースは見たことが無いので  
  >   BANK0切り替えをしているソフトは存在しないかもしれません。

### ゲームIDの取得方法

  詳細は KONAMI8K.ASM の GET_KONAMI_ID の処理を参考にしてください。

  1. ロムヘッダ検査 (4000H が 'AB')
  2. 4002Hに書かれたアドレスから+FFHの範囲に値としてH_TIMI(FD9Fh)かH_KEYI(FD9AH)があるか検査
  3. 4010Hに'AB'か'CD'か'EF'があるか検査。あれば4012HHにゲームIDがある。（終了）
  4. そうでなければ、5000H～50FFHの合計値を計算し、  
     ゲーム毎の合計値リストと照合してゲームIDを決定(終了)

## SCCかどうかの検査案

  1) 型番リストを作って4010h-4013hの値を調べる  
  2) SCCバンク切り替えコードの存在を検索する  
     ```  
     LD   A,3Fh      ;3E 3F  
     LD   (9000h),A  ;32 00 90  
     ```

### 参考

新10倍カートリッジ対応表  
https://www.msx.org/wiki/Konami_Game_Master_2  

| Product | Title | Eng  
| --- | --- | ---  
| RC 700 | わんぱくアスレチック           | Athletic Land                           |
| RC 701 | けっきょく南極大冒険           | Antarctic Adventure                     |
| RC 702 | モン太君のいち・に・さんすう   | Monkey Academy                          |
| RC 703 | タイムパイロット               | Time Pilot                              |
| RC 704 | フロッガー                     | Frogger                                 |
| RC 705 | スーパーコブラ                 | Super Cobra                             |
| RC 706 | コナミのビリヤード             | Konami’s Billiards (Video Hustler)     |
| RC 707 | コナミの麻雀道場               | Konami’s Mahjong                       |
| RC 710 | ハイパーオリンピック1          | Hyper Olympic 1 (Track & Field 1)       |
| RC 711 | ハイパーオリンピック2          | Hyper Olympic 2 (Track & Field 2)       |
| RC 712 | サーカスチャーリー             | Circus Charlie                          |
| RC 713 | マジカルツリー                 | Magical Tree                            |
| RC 714 | I love 社会 ぽんぽこパン       | Comic Bakery                            |
| RC 715 | ハイパースポーツ1              | Hyper Sports 1                          |
| RC 716 | キャベッジパッチキッズ         | Cabbage Patch Kids                      |
| RC 717 | ハイパースポーツ2              | Hyper Sports 2                          |
| RC 718 | ハイパーラリー                 | Hyper Rally                             |
| RC 720 | コナミのテニス                 | Konami’s Tennis                        |
| RC 721 | スカイジャガー                 | Sky Jaguar                              |
| RC 724 | コナミのベースボール           | Konami’s Baseball                      |
| RC 725 | イーアルカンフー               | Yie Ar Kung Fu                          |
| RC 727 | 王家の谷                       | King’s Valley                          |
| RC 728 | モピレンジャー                 | Mopi Ranger                             |
| RC 729 | ピポルス                       | Pippols                                 |
| RC 730 | ロードファイター               | Road Fighter                            |
| RC 731 | コナミのピンポン               | Konami’s Ping Pong                     |
| RC 732 | コナミのサッカー               | Konami’s Soccer (Konami’s Football)   |
| RC 733 | ハイパースポーツ3              | Hyper Sports 3                          |
| RC 734 | グーニーズ                     | The Goonies                             |
| RC 736 | コナミのボクシング             | Konami’s Boxing                        |
| RC 737 | イーガー皇帝の逆襲             | Yie Ar Kung Fu 2                        |
| RC 739 | 魔城伝説                       | Knightmare                              |
| RC 740 | ツインビー                     | Twin Bee                                |
| RC 742 | グラディウス                   | Gradius (Nemesis)                       |
| RC 743 | 夢大陸アドベンチャー           | Penguin Adventure                       |
| RC 744 | 悪魔城ドラキュラ               | Vampire Killer                          |
| RC 745 | キングコング2                  | King Kong 2                             |
| RC 746 | Qバート                        | Q-Bert                                  |
| RC 747 | 火の鳥 鳳凰編                  | Hinotori (Firebird)                     |
| RC 748 | がんばれゴエモン!からくり道中  | Ganbare Goemon                          |
| RC 749 | 魔城伝説Ⅱガリウスの迷宮       | The Maze of Galious                     |
| RC 750 | メタルギア                     | Metal Gear                              |
| RC 751 | グラディウス2                  | Gradius 2 (Nemesis 2)                   |
| RC 752 | F-1スピリット                  | F-1 Spirit                              |
| RC 753 | ウシャス                       | The Treasure of Usas                    |
| RC 754 | シャロム 魔城伝説III 完結編    | Shalom                                  |
| RC 757 | THEプロ野球 激突ペナントレース | Clash Pennant Race 1                    |
| RC 758 | 沙羅曼蛇                       | Salamander                              |
| RC 759 | パロディウス                   | Parodius                                |
| RC 760 | エルギーザの封印 (MSX1)        | King’s Valley 2 (MSX1)                 |
| RC 761 | エルギーザの封印 (MSX2)        | King’s Valley 2 (MSX2)                 |
| RC 762 | 魂斗羅                         | Contra                                  |
| RC 764 | ゴーファーの野望EPISODEII      | Gofer's Ambition Episode II (Nemesis 3) |
| RC 765 | 牌の魔術師                     | Hai no Majutsushi                       |
| RC 766 | 激突ペナントレース2            | Clash Pennant Race 2                    |
| RC 767 | ソリッドスネークメタルギア2    | Metal Gear 2                            |
| RC 768 | スペースマンボウ               | Space Manbow                            |
