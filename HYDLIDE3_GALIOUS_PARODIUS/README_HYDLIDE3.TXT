ハイドライド3 for MSX1版/MSX2版関連メモ

┏━━━━━━━━━━━━━━━━┓
┃      HYDLIDE3 ツール関連       ┃
┗━━━━━━━━━━━━━━━━┛

RUN "HYDLIDE3.BAS"
で実行。

対応機種：
        MSX/MSX2/MSX2+/MSXturboR
        MSX-DOS/MSX-DOS2対応
        要:RAM64KB以上（メモリマッパ不要）
        ※MSX2版の場合はMSX2以上 VRAM128KB以上

HYD3STRT.BOF    ...マシン語ファイル $A000にロードされる
HYD3-EXP.BOF    ...マシン語ファイル $FA75にロードされる
*.H3B   ... MSX1版状態セーブファイル（RAM+VRAMで1ファイル）
*.H3M   ... MSX2版状態セーブファイル（RAM）
*.H3V   ... MSX2版状態セーブファイル（VRAM）

    ※ H3Vは128KB以上あるので、2DDフロッピーをかなり圧迫する。

● 機能

        ※ ターボR/DOS2対応。
        ※ ターボRの場合、ツール処理はR800、ゲーム中はZ80で動作。

    [G] PLAY GAME
        新規ゲームを実行する。
        セーブデータの領域を使う。
        ※HYD3CHAR.BASでデータを編集した後はCONTINUEを避け、
          [G]で新規ゲームを開始をすると良い。

    [C] CONTINUE GAME
        中断データがあれば、中断したところから再開する。
        【非推奨】（安定しないケースがある）

        ※ MSX2版はカラーパレットやVDPの状態を復元するために
           一度Bボタン（RETURNキー）でメニューを開くこと。

        ※再開の場合、表RAM0C000Hのセーブデータは破棄され、
          裏RAMに保存された中断データエリアのセーブデータが使用される。

        ※中断データの存在チェックは甘いので、
          再起動や他のプログラムで部分的に破壊されていても、
          メモリ内にヘッダが存在すると中断データがあると判定される事がある。

    [M] FORCE CAMP NOW
        プレイ中断中の状態をセーブデータ領域に強制的に書き込む。
        現在位置でキャンプしたのと同じ扱いになる。
        （回復はしない）

       【推奨】実質的に一番安全な状態セーブが可能。

            [S] SAVE CHARAVTERでディスクへ書き出し
            [L] LOAD CHARACTERでディスクから読み出し
            [G] PLAY GAMEで始めてゲームスタート

    [L] LOAD CHARACTER
        セーブデータ（4人分）をディスクから読み込む。
        そのあと、ゲームを新規実行する。

    [S] SAVE CHARACTER
        セーブデータ（4人分）をディスクに保存する

    [R] STATE LOAD
        中断データをディスクから読み込む。
        そのあと、ゲームを中断箇所から再開する。
        【非推奨】（安定しないケースがある）

    [W] STATE SAVE
        中断データをディスクに保存する
        【非推奨】（安定しないケースがある）

    [P] COLOR:MSX2/MSX1
        （MSX1版の場合）MSX1風パレットに切り替える。

● 拡張ポーズ（ゲーム中）

    ●STOPキーで拡張ポーズ
    （BlueMSX:PageUp / OpenMSX:F8 / 1chipMSX:End）

    ●拡張ポーズ中 （capsランプ点滅）
    ・STOP        ゲームに戻る
    ・CTRL+@      ゲームを中断してBASICに戻る（状態は保存される）
    ・CTRL+HOME   ゲームソフトリセット
    ・CTRL+F5     エンディング強制実行 （タイトルデモ中は危険）
                  ※ サウンドテストにエンディングが含まれない為追加

    ●CTRL+@でBASICに戻った後
    ・BASICに戻った後[C] CONTINUEで中断した状態から再開できる
    ・BASICに戻って[M]を押して強制セーブした場合は、
      [G] PLAY GAMEで開始して、セーブデータをロード開始する事
    ・[W]で中断状態をファイルへ保存
      [R]でファイルに保存した中断データから再開
    ・[S]でセーブデータをファイルへ保存（FMPAC/PACやテープの代わり）
      [L]でセーブデータをファイルから読み込み

● 状態セーブロード機能について

    ・ゲームを中断してBASICへ戻り、再開する機能
    ・ディスクへの状態丸ごとセーブロード

    ※注）SCREEN0以外に切り替えるとVRAM状態が復帰できません
    ● MSX版は安定
    ● MSX2版は条件付き
        ・MSX2版は正常にパレットを復帰不能
        ・ゲーム中以外の保存が不安定。
        ・タイトルデモ/エンディングへの復帰は画面がおかしくなり、暴走の可能性もある
        その他詳細は後述します。

● キャラデータ改造について 

    1. RUN"HYDLIDE3.BAS
    2. カートリッジ後挿し
    3. LOAD CHARACTERSまたはPLAY→STOP→CTRL+@
       (ゲームを中断してツールに復帰)
    4. CHARA DATA EDIT → CTRL+STOP→RUN"HYDLIDE3.BAS
    5. SAVE CHARACTERS
    6. LOAD CHARACTERS
      （データをゲーム用領域に読み込んでゲームを実行）

    ※ SAVEした改造データはLOADで反映・PACにも保存

● 暴走？

    ●1chipMSXのクロックアップモードでMSX2版を動かしていると、
      しばらくすると暴走する模様。

      （このツールが原因かどうかは不明）
      （おそらくVDP操作に失敗する？）

● BASIC側ツール用ワーク

    $C000,$400  保存キャラクターデータの受け渡しバッファ（4キャラ分）
                ここを読み書きしてツール(HYDLIDE3.BAS)に渡すとプレイヤーデータが書き換わる。
                1キャラ256バイトで、最後の1バイトはチェックサム。

                チェックサムは(+$00)～(+$FE)の内容合計+$4A
                BLOAD"HYD3STRT.BOF":DEFUSR5=&HA000+15:A=USR5(データアドレス)

    HYDLIDE3.BASでゲームを実行後、
    BASICに戻ったらCTRL+STOPでプログラムを中断。
    CLEAR200,&HBFFF:RUN"HYD3CHAR.BAS"
    で、キャラクタデータが改造可能。

    編集したら、RUN"HYDLIDE3.BAS"を実行
    [S]でファイルへ保存。[L]や[G]で改造セーブデータを読み込み開始。
    ※注）[C]CONTINUEでは$C000のセーブデータはゲームに反映されない。

● MSX2版：中断・再開機能について補足

    ● 概要
    VDPアクセスにBIOSを使用していない為、
        ・パレットが再現出来ない
             → メニューを（開いて）閉じる、建物に入って出るで治る
        ・メーカーロゴ/タイトル/エンディングで中断すると画面がおかしくなる
        ・その他、VDP直接操作中の中断は不安定になる可能性がある
  
    ● 詳細
    ・パレットの保存方法がないため、メニュー画面用パレットで再開している。
        → フェードアウト中に中断・再開しない。
        → なるべくメニュー画面で中断する。
        → メニューを開いて閉じる/入口出口で移動するとパレットが正常になる。

    ・メーカーロゴ画面に対応していない
        ・一時的にSCREEN5になっている：対応していない。
        ・パレットアニメーションの復帰に対応していない。
            → 将来的に判定できれば対応可能かもしれない（現状未対応）

    ・タイトルデモのパレット2倍表示に対応していない。
        ・パレットの復帰に対応していない
        ・HSYNC割り込みの状態を保存復帰できない。
            → 将来的に判定できれば対応可能かもしれない（現状未対応）

    ・エンディングアニメーション時の画面に対応していない
        ・一時的にSCREEN5になっている：対応していない。
        ・パレットの復帰に対応していない
            → 将来的に判定できれば対応可能かもしれない（現状未対応）

    ・ディスクの読み書きが遅い
        ・VRAM128KBを読み書きするため遅い。
        ・バッファが$2000しかないのでさらに遅い。
        ・裏RAM$6000-$7FFFが空いているがディスクアクセス中は使いづらい

    ● MSX2版ステートロード時カラーパレット

        VDPを直接アクセスしているため、パレットは読みだせない。
        （保存できない）

        再開時、パレットは決め打ち。お好みで。

        マップ共通パレット（UIのみ）
        A$="000000000537000056163750000000000754015610777000" 'MSX2PAL(COMMON)

        昼の街のパレット
        A$="567455430537541056163750153432222754015610777000" 'MSX2PAL(TOWN/NOON)

        ※（調査中）ゲーム中の状態を解析してパレット設定ルーチンを呼び出す事自体は可能？
        タイトル        $00,$01,$06,$07
        エンディング    $00,$01,$06,$07
        トップメニュー  $0A,$0B,$08,$0F
        ゲームメニュー  $09,$0A,$08,$0F
        建物の中        $0A,$0B,$08,$0F
        町中            $0D,$0E,$08,$0F
            ※バンク番号だけでは識別できない


==============================================================================
    おまけ  キャラクターデータエディタ
==============================================================================

┏━━━━━━━━━━━━━━━━┓
┃          HYD3CHAR.BAS          ┃
┗━━━━━━━━━━━━━━━━┛

● 重いのでターボR推奨

● 編集したらセーブ推奨
    編集した後に"HYDLIDE3.BAS"ツールを起動
    [G] CONTINUE GAME になっている場合は、
    [S] CHARACTER SAVE で、データセーブをして
    [L] CHARACTER LOAD で、データロード開始
    で、編集したパラメータで遊べる。

    （CONTINUEの場合、編集したセーブデータは破棄されてしまう）

● HYDLIDE3.BAS実行後だとフリーエリアが足りなくて読み込めないので
    CLEAR 200,&HBFFF:RUN"HYD3CHAR.BAS"
   で実行すると良い。

**** パラメーター
DATA "XXYYName:LAA/L"

 "XX" "YY" "Name" ":" "L" "AA" "/" "L"...

XX      表示位置X（16進数）
YY      表示位置Y（16進数）
Name    PR$=名前
L       PL(N):値の種類
AA      PA(N):データアドレス（オフセット値）（16進数）
/       P$(K)=次の文字(PL)が"0"以外なら値の後に表示。":"、"/"、"g"

**** PL(値の種類) ****
0: NONE
1: 16byte,String (name)
2: 1byte ,0-12 (magic level)
3: 1byte ,0-255
4: 1byte ,0-1 (flag)
5: 2byte ,0-65535
6: 1byte ,0-8 (class)
7: "g"
8: 3byte ,0-16777215
9: 1byte ,-1  (Arms)
A: 1byte ,+13 (Armor)
B: 1byte ,+19 (Shield)
C: 1byte ,+24 (Helmet)
D: 1byte ,0-67 (Item)
E: Dummy (item list)
F: Dummy (Character Change)


┏━━━━━━━━━━━━━━━━┓
┃       キャラクターデータ       ┃
┗━━━━━━━━━━━━━━━━┛
(RAM)
$D001, 1    :表示言語 0=日本語のみ、1=英語+日本語、2=英語のみ
$D0A4, 1    :プレイ中キャラクター番号(0～4)
$D004, $100 :プレイ中キャラクターデータ
             サイズ = 256
$C000, $400 :キャラクターデータ（4人）
             サイズ = 256 * 4

    ※ 間違ってるところがあるかも

        位置 サイズ 日本語名        英語名          値の範囲
        ========================================================
$d004   +$00, 16    名前            Name            (文字列)
$d015   +$11, 1     ====不明==== 加算カウンター?
$d016   +$12, 1     レベル          Level           (0-255)
$d017   +$13, 1     職業            Class           (0-8)
$d018   +$14, 2     体力            Life            (0-65535)   最大値
$d01a   +$16, 2       〃                            (0-65535)   現在
$d01c   +$18, 2     危険体力 (危険体力/2+1 > 現在体力 = "危険")
$d01e   +$1A, 1     ====不明====
$d01f   +$1B, 1     ====不明====
$d020   +$1C, 1     腕力            Strength        (0-255) 
$d021   +$1D, 1     ====不明====
$d022   +$1E, 2     魔力            Magic Point     (0-65535)   最大値
$d024   +$20, 2       〃                            (0-65535)   現在
$d028   +$24, 1     魔法レベル      Magic Level     (0-12)
$d029   +$25, 1     攻撃値          Attack Point    (0-255) 
$d02a   +$26, 1       〃                            (0-255) 基本値
$d02b   +$27, 1     防御値          Armor Class     (0-255) 
$d02c   +$28, 1       〃                            (0-255) 基本値
$d02d   +$29, 1     機敏さ          Agility         (0-255) 
$d02e   +$2A, 1       〃                            (0-255) 基本値
$d02f   +$2B, 1     ====不明====
$d030   +$2C, 1     器用さ          Dextality       (0-255)
$d031   +$2D, 1       〃                            (0-255) 基本値
$d032   +$2E, 1     教養            Inteligence     (0-255)
$d033   +$2F, 1       〃                            (0-255) 基本値
$d034   +$30, 1     幸運            Luck            (0-255) 
$d035   +$31, 1       〃                            (0-255) 基本値
$d036   +$32, 1     魅力            Charm           (0-255)
$d037   +$33, 1       〃                            (0-255) 基本値
$d038   +$34, 1     精神力          Mind force      (0-255)
$d039   +$35, 3     経験値          Experience      (0-16777215)(999999以上は表示が化ける)
$d03c   +$38, 1     ====不明====
$d03d   +$39, 1     ====不明====
$d03e   +$3a, 1     ====不明====
$d03f   +$3B, 1     妖精            Fairy           (0,1)
$d040   +$3C, 1     怪物            Monster         (0,1)
$d041   +$3d, 1     ====不明====
$d042   +$3E, 2     持てる重量      Have Weight     (0-65535)
$d044   +$40, 2     使いこなす      Master Weight   (0-65535)
$d046   +$42, 2     道具の総重量    All Weight      (0-65535)
$d048   +$44, 1     ====不明====
$d049   +$45, 1     ====不明====
$d04a   +$46, 1     ====不明====
$d04b   +$47, 3     所持品(1)      Item             (0-68)(0-255)(0,1)
        ...         アイテム番号、所持数、使用中 の計3byte
        ...         アイテム番号が$FFなら空欄
$d084   +$80, 3     所持品(20)ここまで
$d087   +$83, 1     10gold
$d088   +$84, 1     100gold
$d089   +$85, 1     1000gold
        
$d08a   +$86, 1     ====不明====
        ...             
$d096   +$92, 1     ====不明====

$d097   +$93, 1     武器            Weapon           (0-14)-1
$d098   +$94, 1     鎧              Armor            (0-6)+13
$d099   +$95, 1     盾              Shield           (0-5)+19
$d09a   +$96, 1     兜              Helmet           (0-4)+24
$d09b   +$97, 1     直接攻撃距離    Direct Len       (0-255)
$d09c   +$98, 1     飛び道具距離    Fly Length       (0-255)
$d09d   +$99, 1     弾の種類        Bullet           (0-255)

$d100   +$FC, 1     ゲームクリア済みフラグ（銀行がBGMモードになる）
        
        +$FF, 1     チェックサム
                    BA=キャラデータのアドレス先頭
                    A=0:FORI=0TO254:A=A+PEEK(BA+I):NEXT:A=A AND &H4A

**** Class ****

$d017   +$13, 1     職業            Class           (0-8)
$d040   +$3C, 1     怪物            Monster         (0,1)

0       1       2       3       4       5       5       6       7
Fighter Robber  Priest  Monk    Warrior Thief   Bishop  Bishop  Hero
Monster

0     1     2     3     4     5     6     7     8
戦士  強盗  僧侶  修道士強者  盗賊  僧正  僧正  英雄
怪物  

文字列番号：（bank28)   通常：n + $37
                        怪物：$46(70)

**** Item ****

(ROM:$5157B)

(+0)
Dagger___________ Short Sword______ Long Sword_______ Holy Sword_______ 
Silver Sword_____ Fire Sword_______ Laser Sword______ Sling____________ 
Spear____________ Little Bow_______ Great Bow________ Club_____________ 
Axe______________ Battle Axe_______ 

(+14)
Leather Suit_____ Chain Armor______ Steel Armor______ Silver Armor_____ 
Magic Armor______ Fairy Armor______ 

(+20)
Shield___________ Mind Shield______ Steel Shield_____ Life Shield______ 
Fairy Shield_____ 

(+25)
Helmet___________ Yamatec__________ Star Helmet______ Fairy Helmet_____ 

(+29)
Heal_____________ Antidote_________ Herb_____________ +3 Heal__________ 
+5 Heal__________ Max Heal_________ Cup of Soma______ Phony medicine___ 
Gold Exchanger___ Cross of God_____ Stone of Fighter_ Tool of Camp_____ 
Midnight eye_____ Amulet of Magic__ Food_____________ Lamp_____________ 
Oil______________ Super oil________ $10 Gold-Coin____ $100 Gold-Coin___ 
$1000 Gold-Coin__ VIP Card_________ Cream of NIBEA'N_ Amulet of ATSUTA_ 
Doll of YUMI_____ T&E Package______ Odo-Later________ Stone of Pickles_ 
Sun-Oil__________ Fang of Dragon___ JIM's Scroll_____ ID-Card__________ 
Stone of Cloud___ Bugle____________ Idol of VARALYS__ Amulet of Exit___ 
Space Compass____ Space Suit_______ Amulet of DM.____ Holy water_______ 
(+69)


==============================================================================
    おまけ  HYDLIDE3.BAS プログラム解説
==============================================================================

● HYD3STRT.ASM

スタック用：$AFC0-$AFFF（$40バイト）
プログラム：$A000-$A939（空きあり）

    ●フックテーブル
    +0   $A000,3    (USR0)  JP HYDLID3_  ゲーム開始/再開
    +3   $A003,3    (USR1)  JP HYD3_CHK  ハイドライドのROMが刺さっているかチェック
    +6   $A006,3    (USR2)  JP HYD3SAVE  セーブデータをディスクにセーブする
    +9   $A009,3    (USR3)  JP HYD3LOAD  セーブデータをディスクからロードする
    +12  $A00C,3    (USR4)  JP CAMPCHAR  プレイ中断中キャラクタがいたら、$:  Sに書き出す
    +15  $A00F,3    (USR5)  JP CHARSUM@  キャラクターデータのチェックサムを計算する
    +18  $A012,3    (USR6)  JP CHREEVAC  キャラクター編集データ退避/復帰（ディスクバッファ使用時の破壊回避）
    +21  $A015,3            JP RET_BAS   HYD3-EXTからBASICに戻る処理（ゲーム中断）

    ●ワークエリア
    +24  $A018,1    ROMSLT  （読み出し専用） ハイドライド3を検出したスロット番号
    +25  $A019,1    GAMVER  （読み出し専用） ハイドライド3ロムチェックの結果
                                            0:なし / 1:MSX版 / 2:MSX2版
    +26  $A01A,1    SAVVER  （読み書きあり） メモリ上にある中断データのバージョン
                                            0:なし / 1:MSX版 / 2:MSX2版
                                            0以外なら保存可能
    +27  $A01B,1    DSKERV  （読み出し専用） セーブロードでエラーが起きたら0以外の値

    +28  $A01C,1    _BANK0  （読み出し専用） 中断時のROMバンク番号（ページO）
    +29  $A01D,1    _BANK1  （読み出し専用） 中断時のROMバンク番号（ページ1）
    +30  $A01E,1    _BANK2  （読み出し専用） 中断時のROMバンク番号（ページ2）
    +31  $A01F,1    _BANK3  （読み出し専用） 中断時のROMバンク番号（ページ3）
    +32  $A020,1    PACSLT  （読み出し専用） FM-PAC/PAC が刺さっていればそのスロット番号

    +33  $A021,64*6 IDDTBL   ROMバンク特定用のデータリスト
                            （各バンクからピックアップした6byte値*64バンク分）
    +417 $A1A1,64   IDDCHK   ROMバンク特定用データ(IDDTBL)の重複チェックリスト
                             特定用データでヒットしたバンクの数
                            （バンクの内容が全部0なら+$80）
                             ・1なら正常
                             ・$80以上なら無視（空きバンク）
                             ・2～64ならエラー（1個に絞り切れていない）

    （以降、非公開ワークとプログラム本体）

    ●BANK特定データ
    HYDLIDE3.BASで、ロム認識後のコマンド受付時、
    [SHIFT]+[?]でバンク特定用ハッシュをテキスト出力。
    （IDDTBL、IDDCHKの内容）

    HYD3M1ID.TXT    ... MSX1版の場合
    HYD3M2ID.TXT    ... MSX2版の場合

    ハイドライドⅢはワークエリアを使用せず直接バンク切り替えするケースがあり、
    現在のバンク選択状態を知る方法は現在のメモリの状態を調べる事となる。

    全比較では遅くなるため、ハッシュテーブルを作成して比較している。

    空のバンク以外は特定ハッシュ値が重複するとまずいため、
    チェック用にテキスト出力機能を隠し機能として用意。

    （※ 自動的な重複エラー報告機能は追加していない。目視で確認する）

    例）MSX1版初期ロット

        Bank:Address:Identify(HitCount:AllZero)
        00:00000:495F00E13E30(01:N) 01:02000:E0766D000040(01:N)
        02:04000:FF50220FE060(01:N) 03:06000:000000000000(0D:Z)
        04:08000:FF3DFF10ABF0(01:N) 05:0A000:3C8700027200(01:N)
        06:0C000:000000000000(0D:Z) 07:0E000:000000000000(0D:Z)
        08:10000:9205209AFD00(01:N) 09:12000:AF21D0A78754(01:N)
        0A:14000:AFDA3E074850(01:N) 0B:16000:DB3A9BFAB900(01:N)
        0C:18000:000000000000(0D:Z) 0D:1A000:9740283A80D0(01:N)
        0E:1C000:55565F022CFE(01:N) 0F:1E000:3106CD01015E(01:N)
        10:20000:2420584C8181(01:N) 11:22000:00D00B8A8A04(01:N)
        12:24000:BD40202484B1(01:N) 13:26000:3B3EAC29693F(01:N)
        14:28000:406060800000(01:N) 15:2A000:000000000000(0D:Z)
        16:2C000:000000000000(0D:Z) 17:2E000:000000000000(0D:Z)
        18:30000:B07FE0F2FF00(01:N) 19:32000:B0F7F7EFFF00(01:N)
        1A:34000:B02BC0EEFFFF(01:N) 1B:36000:B05F4291FF5F(01:N)
        1C:38000:B0FEC571FFFF(01:N) 1D:3A000:B07F514DFFFF(01:N)
        1E:3C000:B09E51E6FF00(01:N) 1F:3E000:000000000000(0D:Z)
        20:40000:000000000000(0D:Z) 21:42000:000000000000(0D:Z)
        22:44000:000000000000(0D:Z) 23:46000:000000000000(0D:Z)
        24:48000:0808A00812A0(01:N) 25:4A000:000000000000(0D:Z)
        26:4C000:80FE4395A2DE(01:N) 27:4E000:0422743F6D04(01:N)
        28:50000:AFFEF3E55661(01:N) 29:52000:200010001266(01:N)
        2A:54000:D81000F27793(01:N) 2B:56000:342776493434(01:N)
        2C:58000:34CE1C1A053F(01:N) 2D:5A000:767649051A25(01:N)
        2E:5C000:1A198E343434(01:N) 2F:5E000:C9C9D626D619(01:N)
        30:60000:233F341949E4(01:N) 31:62000:31E3F1051464(01:N)
        32:64000:B8BDF7F70BF7(01:N) 33:66000:CACA3AF3EEF4(01:N)
        34:68000:68F4F4AF6776(01:N) 35:6A000:EAAFF470EA67(01:N)
        36:6C000:FAFAFA43FA7F(01:N) 37:6E000:E5EB7BF3E5F1(01:N)
        38:70000:84F3EB9F7A9E(01:N) 39:72000:0000EAEAA3CF(01:N)
        3A:74000:0DF3F3EBA2EB(01:N) 3B:76000:0D2FF1EAEC96(01:N)
        3C:78000:1C64E5E3DAAA(01:N) 3D:7A000:EAFEFEFEEAE3(01:N)
        3E:7C000:F4E2850DE3E3(01:N) 3F:7E000:FE0850FF4000(01:N)
    
        ※Zのついた空バンクは重複OK。それ以外はヒット数1が正常。
        ※バンクの空チェックは、2000Hすべて0かどうかで判定すると遅いため、
          100Hごとにチェックしている。


● HYD3-EXP.ASM

        ●ベクタ
        +0      $F975,2         VERSION         バージョン番号
        +2      $F977,2         EXPSIZ          プログラムサイズ
        +4      $F979,2         EX_TRAP         割り込み処理開始アドレス
        +6      $F97B,2         SET_UP          新規ゲーム開始処理アドレス
        +8      $F97D,2         CONTINUE        ゲーム再開処理アドレス

        ●ワークエリア
        次項参照

● HYD3STRT と HYD3-EXPのやりとり用

    ゲーム中の$C000-$FFFB

    BASIC時は裏RAM$0000-$3FFBに置かれる。
    （ゲーム実行時に入れ替わる）
    （裏RAM入れ替え時、16BIT値のチェックサムを計算し$3FFCに格納）


    ゲーム時の$C000-$FFFBの内容（BASIC時の裏RAM$0000-3FFB）は
    状態セーブロード時に読み書きされる。
    （ほかにはVRAMデータも読み書きされる）

    ●ゲーム拡張割り込み処理 スタックエリア
    $0F975,74   (VCBA-VCBB)

    ●ゲーム拡張割り込み処理 ワークエリア
    $FA75,37    (VCBC)
                + 0, 1  BANK_0  ROM BANK 0 のバンク番号
                + 1, 1  BANK_1  ROM BANK 1 のバンク番号
                + 2, 1  BANK_2  ROM BANK 2 のバンク番号
                + 3, 1  BANK_3  ROM BANK 3 のバンク番号
                + 4, 2  BASVER  HYD3STRTのバージョン（中断データ検査用)
                + 6, 2  EXPVER  HYD3-EXPのバージョン（中断データ検査用)
                + 8, 1  MSXVER  ROMのMSXバージョン（中断データ検査用)
                + 9, 3  （空き）
                +12, 1  CAPSランプ状態（点滅用）
                +13, 7  （空き）
                +20, 2  HYD3-EXPメニュー実行時スタックポインタアドレス（再開用）
                +22, 1  （空き）
                +23,13  PSGレジスタ#0-#12保存用
                +36, 1  （空き）（PSGレジスタ#13用予約）

    ●ゲーム拡張割り込みプログラム
    $F975,$180  (VOICAQ - VOICCQ)
                +0,2    DW VERSION  バージョン番号
                +2,2    DW EXPSIZ   HYD3-EXPのプログラムサイズ
                +4,2    DW EX_TRAP  割り込み処理アドレス
                +6,2    DW SET_UP   新規ゲーム開始処理アドレス
                +8,2    DW CONTINUE ゲーム再開処理アドレス
                （以降、プログラム本体）

・中断時：  拡張割り込みモードからHYD3STRTに処理を戻す
            GAMVER:ROMタイプ（0：なし、1:MSX1版、2:MSX2版）
            (SAVVER)と(MSXVER)に状態データタイプ（0：なし、1:MSX1版、2:MSX2版）
            （MSXVERは保存データ側に格納されている値）
            （SAVVERはHYD2STRT側に格納されている値）

・HYD3_CHK：HYDLIDE3がささっているか調べる

            ささっていれば、
            1.MSX1版かMSX2版か調べる
            2.ROMSLOTに検出したスロット番号を書き込む
            3.メガROMバンク特定用データを作成する
            4.MSXVER含めて状態保存データのバージョンを調べる

            バージョンがあっていればSAVVERをMSXVERの値で上書きする

            返り値は、0=なし、1=MSX1版、2=MSX2版
            (ROMSLOT)にスロット番号

・保存時：  SAVVER(MSXVER)に合わせて保存処理実行
                        （保存前にMSX1版とMSX2版ロムが入れ替わっていても大丈夫）

・再開時：  再開条件
            1.(GAMVER==SAVVER) && (GAMEEVR>0)
            2.RAMページ3とVRAMが維持されていれる
              (RAMページ0のチェックサムも判定)
              (RAMページ0：ゲーム時のRAMページ3、
               RAMページ1：ゲーム時のVRAM先頭2000H)
            3.保存されていたゲーム時RAMページ3のBASVER、EXPVERが正しい

                        保存されていたRAMページ3とBASIC時のRAMページ3を入れ替え
            中断時のROMバンクを復帰し、
                        拡張ポーズモードから再開

            ※ VRAMのチェックはしていないのでVRAMを破壊しないように要注意

● VDP レジスタ

R#0-R#7,R#8-R#13,R#23を設定
(R#14-R#17,R#18-R#22は設定しない)

#VDP REGISTER   0       4       8       12  ----16--    20    23
MSX1            026206FF0336070028000000000000000F000000003B0500    SCREEN2
MSX2            0A621F8001F73E0F28000003000000000F000000003B0500    SCREEN7
MSX2 T&E LOGO   06621FFF01EF0F000A800000000002000F2F0000003B0500    SCREEN5
MSX2 TITLE LOGO 0A621FFF01F71E000A80000100000600002F0000003B05E6    VSCROL
MSX2 TITLE DEMO 1A621FFF01F71E000A80000100000600002F0088003B0522    VSCROL/HSYNC
MSX2 ENDING     06621F8001EF0F0008800000000006000B2F0000003B0500    SCREEN5

● MSX1（TMS9918）風パレット

RGB:000 000 353 464 327 437 532 356 632 643 563 664 241 535 555 777 

VDP DATA: (RB,0G)
    DB $00,$00, $00,$00, $33,$05, $44,$06,
    DB $37,$02, $47,$03, $52,$03, $36,$05,
    DB $62,$03, $63,$04, $53,$06, $64,$06,
    DB $21,$04, $55,$03, $55,$05, $77,$07,


==============================================================================
    おまけ  解析情報メモ
==============================================================================

******** MEGA-ROM BANK SELECT ********

ASCII方式8Kbyteバンク タイプ

4MBit=512KByte
8KByte Bank * 64 ($00-$3F)

$6000:$4000-$5FFF
$6800:$6000-$7FFF
$7000:$8000-$9FFF
$7800:$A000-$BFFF

バンクり変えワーク
$a080   di
        ld      ($6000),a
        ld      ($debb),a
        ei
        ret
$a089   di
        ld      ($6800),a
        ld      ($debc),a
        ei
        ret
$a092   di
        ld      ($7000),a
        ld      ($debd),a
        ei
        ret
 ※割り込み中などはこのルーチンを使わずに直接バンク切り替え
バンクページ3は基本的に固定（15)



■キャラパラメータ
******** MSX1/2 共通 ********
(RAM)
$D0A4, 1    :プレイ中キャラクター番号(0～4)
$D004, $100 :プレイ中キャラクターデータ
             サイズ = 256
$C000, $400 :キャラクターデータ（4人）
             サイズ = 256 * 4


■フォント
******** MSX1 ver ********
BANK $01 +$1400-$1FFF
(ROM)$3400-$3FFF
(MEM)$7400-$7FFF

******** MSX2 ver ********
英数字カナフォント
BANK $15 +$1400-$1FFF
(ROM)$2B400-$2BFFF

漢字フォント
BANK $3F +$0000-$1FFF
(ROM)$7E000-$7FFF


■カラーパレット
******** MSX2 ver ********
DATA:$0RGB(WORD) = $GB, $0R(BYTE)
(※VDPは$0GRB = $RB,$0Gで並びが違う)

;パレット書き込み
$a1de:  xor     a
        out     (c),a
        ld      a,$90
        out     (c),a   ;R15=0 カラーパレット0からの書き込み
        inc     c
        ld      b,$10   ;16色
$a1e8:  ld      d,(hl)
        inc     hl
        ld      a,(hl)
        inc     hl
        add     a,a
        add     a,a
        add     a,a
        add     a,a     ;a=a*16
        ld      e,a     
        ld      a,d
        and     $0f
        or      e
        out     (c),a   ; red*16+blue
        ld      a,d
        and     $f0
        rrca
        rrca
        rrca
        rrca
        out     (c),a   ; green
        djnz    $a1e8
        ei
        ret

例）街/昼
8ビット値で書くと
;       gb0r
db      $67,$05, $55,$04, $30,$04, $37,$05
db      $41,$05, $56,$00, $63,$01, $50,$07
db      $53,$01, $32,$04, $22,$02, $54,$07
db      $15,$00, $10,$06, $77,$07, $00,$00

16ビット値で書くと
;        0rgb
dw      $0567,$0455,$0430,$0537,$0541,$0056,$0163,$0750
dw      $0153,$0432,$0222,$0754,$0015,$0610,$0777,$0000

MSXのVDPにそのまま送信する値なら
;        rb  0g
db      $57,$06, $45,$05, $40,$03, $57,$03
db      $51,$04, $06,$05, $13,$06, $70,$05
db      $13,$05, $42,$03, $22,$02, $74,$05
db      $05,$01, $60,$01, $77,$07, $00,$00


（マップカラーパレット）
※ タイトルデモやエンディングのパレットは別
(ROM)BANK $19, $33EA0-$33EFF
(ROM)BANK $1B, $37EA0-$37EFF
(ROM)BANK $1D, $3BEA0-$3BEFF
(ROM)BANK $1F, $3FEA0-$3FEFF
(ROM)BANK $21, $43EA0-$43EFF
(ROM)BANK $23, $47EA0-$47EFF
(ROM)BANK $25, $4BEA0-$4BEFF

(MEM)$7EA0-$7EBF 昼
(MEM)$7EC0-$7EDF 夕
(MEM)$7EE0-$7EFF 夜
昼、夕、夜で2byte*16色*3種類

パレット決定
$bod5:  cd      $a089
$b0d8:  lc      c,$00
        ld      hl,$7ea0
        ld      a,($d09f) ;マップ番号？
        cp      $06
        ret     z
        cp      $11
        jr      c,$b0ed
        cp      $19
        ret     c
        cp      $1c
        ret     nc
$b0ed:  ld      a,($d0b6) ;時刻(BCD値)
        cp      $07
        jr      c,$b0f7
        cp      $12
        ret     c
$d0f7:  ld      c,$01
        ld      hl,$7ec0
        cp      $05
        jr      c,$b103
        cp      $14
        ret     c
$b013:  ld      c,$02
        ld      hl,$7ee0
        ret

●注意点
・メーカーロゴ、タイトル、エンディングは別のパレット処理
・タイトル画面の風景表示中は水平同期でカラーパレット書き換えあり

●マップ限定でパレットを復帰するには
以下が絞り込めれば、マップ限定でパレット復帰可能
・タイトル/エンディング画面かどうか（マップかどうか）
・ROMページ3がパレット決定&書き込み処理のバンクかどうか
・上の処理でワークが書き換えられるが、安全かどうか

    ※ 工事中。実装予定は未定

●その他パレット
ENDING1:    DB  $00,$00, $66,$06, $56,$05, $45,$04, $34,$03, $23,$02, $12,$01, $74,$06
            DB  $06,$01, $72,$03, $21,$01, $70,$04, $52,$02, $21,$01, $77,$07, $00,$00
            ※ カラー10、14はパレットアニメーションあり

探し方:
            OpenMSX Debugger -> Breakpoint -> Add -> IO write watchpoint
            VALUE: $9A
            SLOT: 1（ゲームの差さっているスロット）
            で、パレット書き込みブレークポイント作成可能。


■ 文章データ
******** MSX1/2 共通 ********

● 会話
BANK $26-$27
(ROM)$4C000-$4FFFF

日本語
    テーブル
    (MEM)$4000
        $4c000: $428c   -$4000+$4c000 = $4c28c
                $42a1   -$4000+$4c000 = $4c2a1
                $4280   -$4000+$4c000 = $4c280
                ...
    文字列
        $4c280: \4「なんのこと?」\0
                ...
英語
    テーブル
    (MEM)$49f9
        $4d9f9: $5c84   -$4000+$4c000 = $4dcf9
                $5c9e   -$4000+$4c000 = $4dc9e
                $5c79   -$4000+$4c000 = $4dc79
                ...
    文字列
        $4dc79: \4"What?"\0
                ...

● システム
bank $28-$29:
(rom)$50000-$53fff

日本語
    テーブル
    (mem)$4000
            $50000: $4290   -$4000+$50000 = $50290
                    $4296   -$4000+$50000 = $50296
                    $429f   -$4000+$50000 = $5029f
    文字列
            $50290: 準備
            $50296: ｹﾞｰﾑｽﾀｰﾄ
            $5029f: ｷｬﾗを見る
            ...

英語
    テーブル
        (mem)$4f1d
    $0      $50f1d: $51ad   -$4000+$50000 = $511ad
                    $51b4   -$4000+$50000 = $511b4
                    $51bf   -$4000+$50000 = $511bf
            ...
    $c      $50f35: $521f   -$4000+$50000 = $5121f  Fighter
            ...
    $38     $50f8d: $521f   -$4000+$50000 = $50f8b  Fighter
            ...
    $3b     $50f93: $543c   -$4000+$50000 = $5143c  Warrior
            ...
    $146    $511a9  $61fb   -$4000+$50000 = $521fb  Monster
            ...
    文字列
            $511ad: Set Up
            $511b4: Game Start
            $511bf: Look Status
            ...
            $51f52: Fighter
            ...
            $521fb: Monster
            ...


■ スプライトパターン
******** MSX2 ver ********
●敵キャラスプライト(?)
BANK $15 +0000-$13FF
(ROM)$2A000-$2B3FF

●プレイヤースプライト(?)
BANK $16 +$0000-?
(ROM)$2C000-?

