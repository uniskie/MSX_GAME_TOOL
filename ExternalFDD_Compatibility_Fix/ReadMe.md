# External FDD Compatibility Fix

内蔵FDD以外から起動できないゲームのためのツールです。

きゃんきゃんバニースペリオール用ですが、
もしかしたら
他のゲームにも有効かもしれません。（未確認）

## 使用方法

1. extFdd_fix.dskを起動
2. "INSERT DISK AND HIT ANY KEY"  
   と表示されたらゲームのディスクを入れて  
   SPACEキーやRETURNキーなどを押下

- きゃんきゃんバニースペリオールなど  
  CTRLキーを押しながら起動する必要のあるものは  
  "INSERT DISK AND HIT ANY KEY"がでるまで  
  電源投入時からCTRLキーを押し続ける

## 【原因】きゃんきゃんバニースペリオールの場合

きゃんきゃんバニースペリオールが外付けFDDで動かない原因は、
ゲーム側のバグによるものです。

原因はインタースロットコールでENASLTを呼び出すのが問題で、
せっかくENASLTでスロットを変更しても、
インタースロットコールで戻る時に
基本スロットレジスタが丸ごと元の状態に戻されるのでおかしくなる。
というものです。

- 内蔵FDDの3-2なら基本スロットが変わっても、
  RAMとDISKBIOSの基本スロットは同じなので、
  3-0が選択された状態を維持
- 外付けFDDは1や2に変わってしまう

なので、この処理の前にあらかじめページ1がRAMに変わっていれば
バグを回避できちゃうようです。

ゲームディスクにパッチを当てなくて済むので安全ですね。

## 処理概要

1. ページ1をRAMに明示的に変更
2. メッセージを出してキー入力待ち
3. ゲームのブートセクタ読み込み
4. ゲーム側の処理へジャンプ

※
画面モード変更、文字表示、キー入力待ちがインタースロットコール
になっているのは、CY=1(各種必須初期化が終わった状態)でC01EHが
呼ばれる時には、ページ0がRAMになっているからですが、
かなり手抜きな呼び方になっています。

## おまけ

最初、原因を勘違いしていたんですよね。

私がOpenMSXのデバッガで実際に確認してみた所だと、  
Cy=1でC01EHが呼び出される時は、

- Aレジスタ: 0ならばPOWER ON直後を示す
- DEレジスタ:F363H
  （ページ1をDISKマスタースロットに切換えるフック）
- HLレジスタ：DISKVE
  （ディスクエラー処理アドレスが書いてあるアドレス）

が入っていて、

スロットはページ0から順に、
  RAM、DISKROM、RAM、RAM
となっているようでしたが

レジスタAとDEの内容について、
資料によって違う事を書いてあるんですよね。

DEの値についてドキュメントを信じて
「事前にページ1をRAMに切り替え」をすることで
うまく動いたのですが、
原因をもう少し突き詰めてみたら全然違う要因だし、
DEに入っている値を調べてみたらドキュメントと違うしで困惑しています。

### DEレジスタに入っている値の記載

テクニカルガイドブック第4版やデータパックでは
DEに入っている値が「ページ1をRAMに変えるフック」(F36BH)
と、書いてあるのですが、
実際には 「ページ1をDISKマスタースロットに切換えるフック」(F368H)
が入ってます。

### Aレジスタに入っている値の記載

テクニカルガイドブック第4版では
Aレジスタに起動時のドライブ番号とあるのですが、
データパックでは「0ならばPOWER ON直後を示す」
実の所は良く分かりません。

### HLレジスタに入っている値の記載

HLレジスタの値はDISKVEのアドレスであっているようです。


